name: Claude Automated Work

on:
  # Trigger immediately when issues get priority labels
  issues:
    types: [labeled]

  # Self-chain via repository_dispatch (workflow can't listen to itself via workflow_run)
  repository_dispatch:
    types: [claude-work-continue]

  # Fallback: catch edge cases (reduced frequency since event-driven)
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

  # Manual trigger
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Specific issue number to work on (optional)'
        required: false
        type: number

# Only one work job at a time - queue others
concurrency:
  group: claude-work
  cancel-in-progress: false

jobs:
  # Gate job: check if we should run
  # Skip entirely for non-priority label events to avoid queuing
  should-run:
    if: github.event_name != 'issues' || github.event.label.name == 'P0' || github.event.label.name == 'P1' || github.event.label.name == 'P2'
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          # Always run for manual triggers, schedule, and repository_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || \
             [ "${{ github.event_name }}" = "schedule" ] || \
             [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For issue labeled events, only run if label is P0, P1, or P2
          if [ "${{ github.event_name }}" = "issues" ]; then
            LABEL="${{ github.event.label.name }}"
            if [ "$LABEL" = "P0" ] || [ "$LABEL" = "P1" ] || [ "$LABEL" = "P2" ]; then
              echo "Triggered by priority label: $LABEL"
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "Ignoring non-priority label: $LABEL"
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          echo "should_run=false" >> $GITHUB_OUTPUT

  find-work:
    needs: should-run
    if: needs.should-run.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.find.outputs.issue_number }}
      issue_title: ${{ steps.find.outputs.issue_title }}
      has_more_work: ${{ steps.find.outputs.has_more_work }}
    permissions:
      issues: read

    steps:
      - name: Find highest priority issue
        id: find
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # If specific issue provided, use that
          if [ -n "${{ inputs.issue_number }}" ]; then
            echo "issue_number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
            TITLE=$(gh issue view ${{ inputs.issue_number }} --repo ${{ github.repository }} --json title -q .title 2>/dev/null || echo "")
            echo "issue_title=$TITLE" >> $GITHUB_OUTPUT
            echo "has_more_work=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find all issues by priority (P0 > P1 > P2), excluding claude-working
          FOUND_COUNT=0
          FOUND_NUMBER=""
          FOUND_TITLE=""

          for priority in P0 P1 P2; do
            ISSUES=$(gh issue list --repo ${{ github.repository }} \
              --label "$priority" \
              --state open \
              --json number,title,labels \
              --jq '[.[] | select(.labels | map(.name) | index("claude-working") | not)]' 2>/dev/null || echo "[]")

            COUNT=$(echo "$ISSUES" | jq 'length')

            if [ "$COUNT" -gt 0 ]; then
              if [ -z "$FOUND_NUMBER" ]; then
                # First issue found - this is what we'll work on
                FOUND_NUMBER=$(echo "$ISSUES" | jq -r '.[0].number')
                FOUND_TITLE=$(echo "$ISSUES" | jq -r '.[0].title')
              fi
              FOUND_COUNT=$((FOUND_COUNT + COUNT))
            fi
          done

          if [ -n "$FOUND_NUMBER" ]; then
            echo "Found issue: #$FOUND_NUMBER - $FOUND_TITLE"
            echo "issue_number=$FOUND_NUMBER" >> $GITHUB_OUTPUT
            echo "issue_title=$FOUND_TITLE" >> $GITHUB_OUTPUT

            # Check if there are more issues after this one
            if [ "$FOUND_COUNT" -gt 1 ]; then
              echo "has_more_work=true" >> $GITHUB_OUTPUT
            else
              echo "has_more_work=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No open issues to work on"
            echo "issue_number=" >> $GITHUB_OUTPUT
            echo "has_more_work=false" >> $GITHUB_OUTPUT
          fi

  work-on-issue:
    needs: find-work
    if: needs.find-work.outputs.issue_number != ''
    runs-on: ubuntu-latest
    outputs:
      has_more_work: ${{ needs.find-work.outputs.has_more_work }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mark issue as in-progress
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue edit ${{ needs.find-work.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --add-label "claude-working"

      - name: Work on issue
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          allowed_bots: '*'  # Allow self-chaining via repository_dispatch
          prompt: |
            You are working on issue #${{ needs.find-work.outputs.issue_number }}: ${{ needs.find-work.outputs.issue_title }}

            ## Instructions
            1. Read CLAUDE.md for project context and coding standards
            2. Read the full issue details with: gh issue view ${{ needs.find-work.outputs.issue_number }}
            3. Understand the codebase structure
            4. Implement the required changes
            5. Run tests to verify your changes work
            6. Create a PR with your changes

            ## Development Workflow
            - Create a branch: git checkout -b claude/issue-${{ needs.find-work.outputs.issue_number }}-${{ github.run_id }}
            - Make changes and commit with message referencing the issue
            - Push the branch
            - Create a PR using: gh pr create --title "..." --body "Fixes #${{ needs.find-work.outputs.issue_number }}"

            ## Testing Requirements
            - Run backend tests: cd backend && uv run pytest
            - Run frontend tests: cd frontend && npm test
            - Run linting: cd backend && uv run ruff check . && cd ../frontend && npm run lint

            ## Important
            - Follow existing code patterns
            - Write tests for new functionality
            - Keep changes minimal and focused
            - If you encounter blockers, comment on the issue explaining what's needed

            ## Status Comments (IMPORTANT)
            Post status updates to the issue using `gh issue comment ${{ needs.find-work.outputs.issue_number }} --body "..."`:
            1. **Before starting**: Post "ðŸ¤– Starting work on this issue. [View workflow progress](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            2. **After creating PR**: Post "âœ… Created PR: <PR_URL>. Ready for review."

          claude_args: |
            --max-turns 50
            --dangerously-skip-permissions

      - name: Comment - Work failed
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ needs.find-work.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --body "$(cat <<'EOF'
          ## âŒ Claude encountered an issue

          **Status:** Work failed or was blocked

          **Workflow Run:** [View details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Please check the workflow logs for details. This issue may need manual intervention or clarification.
          EOF
          )"

      - name: Remove in-progress label on completion
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue edit ${{ needs.find-work.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --remove-label "claude-working" || true

  # Self-chain: trigger another run if there's more work
  # IMPORTANT: Only chain on SUCCESS to prevent infinite failure loops
  continue-work:
    needs: [find-work, work-on-issue]
    if: success() && needs.find-work.outputs.has_more_work == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Trigger next work cycle
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "More issues to process, triggering next work cycle..."
          gh api repos/${{ github.repository }}/dispatches \
            -f event_type=claude-work-continue
