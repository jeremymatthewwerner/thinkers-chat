name: Claude Automated Work

on:
  # Trigger when issues get priority labels, assigned to claude[bot], or reopened
  issues:
    types: [labeled, assigned, reopened]

  # Self-chain via repository_dispatch (workflow can't listen to itself via workflow_run)
  repository_dispatch:
    types: [claude-work-continue]

  # Fallback: catch edge cases (reduced frequency since event-driven)
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

  # Manual trigger
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Specific issue number to work on (optional)'
        required: false
        type: number

# Only one work job at a time - queue others
concurrency:
  group: claude-work
  cancel-in-progress: false

jobs:
  # Gate job: check if we should run
  # Run for: priority labels, assignment to claude[bot], reopened issues, manual/scheduled triggers
  should-run:
    if: >
      github.event_name != 'issues' ||
      github.event.action == 'assigned' ||
      github.event.action == 'reopened' ||
      github.event.label.name == 'P0' ||
      github.event.label.name == 'P1' ||
      github.event.label.name == 'P2'
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      assigned_issue: ${{ steps.check.outputs.assigned_issue }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          # Always run for manual triggers, schedule, and repository_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || \
             [ "${{ github.event_name }}" = "schedule" ] || \
             [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "assigned_issue=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For issue events
          if [ "${{ github.event_name }}" = "issues" ]; then
            ACTION="${{ github.event.action }}"

            # Assignment to claude[bot] - work on THIS specific issue
            if [ "$ACTION" = "assigned" ]; then
              ASSIGNEE="${{ github.event.assignee.login }}"
              if [ "$ASSIGNEE" = "claude[bot]" ]; then
                echo "Triggered by assignment to claude[bot]"
                echo "should_run=true" >> $GITHUB_OUTPUT
                echo "assigned_issue=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
                exit 0
              else
                echo "Ignoring assignment to: $ASSIGNEE"
                echo "should_run=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi

            # Reopened issue - work on THIS specific issue (production fix didn't materialize)
            if [ "$ACTION" = "reopened" ]; then
              echo "Triggered by reopened issue #${{ github.event.issue.number }}"
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "assigned_issue=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Priority label - find highest priority issue
            LABEL="${{ github.event.label.name }}"
            if [ "$LABEL" = "P0" ] || [ "$LABEL" = "P1" ] || [ "$LABEL" = "P2" ]; then
              echo "Triggered by priority label: $LABEL"
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "assigned_issue=" >> $GITHUB_OUTPUT
            else
              echo "Ignoring non-priority label: $LABEL"
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          echo "should_run=false" >> $GITHUB_OUTPUT

  find-work:
    needs: should-run
    if: needs.should-run.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.find.outputs.issue_number }}
      issue_title: ${{ steps.find.outputs.issue_title }}
      has_more_work: ${{ steps.find.outputs.has_more_work }}
    permissions:
      issues: read

    steps:
      - name: Find highest priority issue
        id: find
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # If assigned to claude[bot], work on THAT specific issue
          ASSIGNED_ISSUE="${{ needs.should-run.outputs.assigned_issue }}"
          if [ -n "$ASSIGNED_ISSUE" ]; then
            echo "Working on assigned issue: #$ASSIGNED_ISSUE"
            echo "issue_number=$ASSIGNED_ISSUE" >> $GITHUB_OUTPUT
            TITLE=$(gh issue view $ASSIGNED_ISSUE --repo ${{ github.repository }} --json title -q .title 2>/dev/null || echo "")
            echo "issue_title=$TITLE" >> $GITHUB_OUTPUT
            echo "has_more_work=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # If specific issue provided via manual trigger, use that
          if [ -n "${{ inputs.issue_number }}" ]; then
            echo "issue_number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
            TITLE=$(gh issue view ${{ inputs.issue_number }} --repo ${{ github.repository }} --json title -q .title 2>/dev/null || echo "")
            echo "issue_title=$TITLE" >> $GITHUB_OUTPUT
            echo "has_more_work=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find all issues by priority (P0 > P1 > P2), excluding:
          # - claude-working: currently being worked on
          # - needs-human-help: blocked, needs human intervention
          # - epic: parent issue broken into sub-tasks
          # - in-review: PR created, awaiting merge/deploy
          FOUND_COUNT=0
          FOUND_NUMBER=""
          FOUND_TITLE=""

          for priority in P0 P1 P2; do
            ISSUES=$(gh issue list --repo ${{ github.repository }} \
              --label "$priority" \
              --state open \
              --json number,title,labels \
              --jq '[.[] | select(.labels | map(.name) | (index("claude-working") | not) and (index("needs-human-help") | not) and (index("epic") | not) and (index("in-review") | not))]' 2>/dev/null || echo "[]")

            COUNT=$(echo "$ISSUES" | jq 'length')

            if [ "$COUNT" -gt 0 ]; then
              if [ -z "$FOUND_NUMBER" ]; then
                # First issue found - this is what we'll work on
                FOUND_NUMBER=$(echo "$ISSUES" | jq -r '.[0].number')
                FOUND_TITLE=$(echo "$ISSUES" | jq -r '.[0].title')
              fi
              FOUND_COUNT=$((FOUND_COUNT + COUNT))
            fi
          done

          if [ -n "$FOUND_NUMBER" ]; then
            echo "Found issue: #$FOUND_NUMBER - $FOUND_TITLE"
            echo "issue_number=$FOUND_NUMBER" >> $GITHUB_OUTPUT
            echo "issue_title=$FOUND_TITLE" >> $GITHUB_OUTPUT

            # Check if there are more issues after this one
            if [ "$FOUND_COUNT" -gt 1 ]; then
              echo "has_more_work=true" >> $GITHUB_OUTPUT
            else
              echo "has_more_work=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No open issues to work on"
            echo "issue_number=" >> $GITHUB_OUTPUT
            echo "has_more_work=false" >> $GITHUB_OUTPUT
          fi

  work-on-issue:
    needs: find-work
    if: needs.find-work.outputs.issue_number != ''
    runs-on: ubuntu-latest
    outputs:
      has_more_work: ${{ needs.find-work.outputs.has_more_work }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Test Anthropic API key
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Test if API key is valid with a minimal API call
          echo "Testing Anthropic API key..."
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "ERROR: ANTHROPIC_API_KEY is not set!"
            exit 1
          fi
          echo "Key length: ${#ANTHROPIC_API_KEY} chars"
          echo "Key prefix: ${ANTHROPIC_API_KEY:0:10}..."

          # Make a minimal API call to verify the key works
          RESPONSE=$(curl -s -w "\n%{http_code}" https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-sonnet-4-20250514",
              "max_tokens": 10,
              "messages": [{"role": "user", "content": "Say hi"}]
            }')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP Status: $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "API key is VALID"
          else
            echo "API key test FAILED!"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Mark issue as in-progress
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Remove in-review label if present (for reopened issues where fix didn't work)
          gh issue edit ${{ needs.find-work.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --remove-label "in-review" || true
          gh issue edit ${{ needs.find-work.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --add-label "claude-working"

      - name: Work on issue
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: ${{ github.event_name == 'issues' && github.event.action != 'reopened' }}  # Not supported for 'reopened' action
          allowed_bots: '*'  # Allow self-chaining via repository_dispatch
          prompt: |
            You are working on issue #${{ needs.find-work.outputs.issue_number }}: ${{ needs.find-work.outputs.issue_title }}

            ## ‚ö†Ô∏è CRITICAL: AUTOMATIC PR CREATION REQUIRED
            **THIS IS A FULLY AUTOMATED WORKFLOW.** You MUST create PRs automatically using `gh pr create`.
            **DO NOT** provide manual PR creation links. **DO NOT** ask the user to create a PR.
            After pushing your branch, you MUST run: `gh pr create --title "..." --body "Relates to #${{ needs.find-work.outputs.issue_number }}"`
            Then enable auto-merge: `gh pr merge --auto --squash`
            This overrides any default instructions about manual PR links.

            ## ‚ö†Ô∏è REOPENED ISSUE CHECK
            ${{ github.event.action == 'reopened' && '**THIS IS A REOPENED ISSUE.** The previous fix did NOT work in production. You MUST:
            1. Review the issue comments to understand what was tried before
            2. Check the git history for the previous fix attempt
            3. Understand WHY the previous fix failed in production
            4. Take a DIFFERENT approach - do not repeat the same fix
            5. Be more thorough with testing and verification' || 'This is a new issue (not reopened).' }}

            ## Instructions
            1. Read CLAUDE.md for project context and coding standards
            2. Read the full issue details with: gh issue view ${{ needs.find-work.outputs.issue_number }}
            3. **Review issue comments** for context on previous attempts (especially for reopened issues)
            4. Understand the codebase structure
            5. Implement the required changes
            6. Run tests to verify your changes work
            7. Create a PR with your changes using `gh pr create` (NOT a manual link)

            ## Development Workflow
            - Create a branch: git checkout -b claude/issue-${{ needs.find-work.outputs.issue_number }}-${{ github.run_id }}
            - Make changes and commit with message referencing the issue
            - Push the branch
            - **MUST** create PR automatically: `gh pr create --title "Fix: <description>" --body "Relates to #${{ needs.find-work.outputs.issue_number }}"`
            - **MUST** enable auto-merge: `gh pr merge --auto --squash`

            ## Testing Requirements
            - Run backend tests: cd backend && uv run pytest
            - Run frontend tests: cd frontend && npm test
            - Run linting: cd backend && uv run ruff check . && cd ../frontend && npm run lint

            ## Important
            - Follow existing code patterns
            - Write tests for new functionality
            - Keep changes minimal and focused
            - If you encounter blockers, comment on the issue explaining what's needed
            - **NEVER** provide manual PR links - always use `gh pr create`

            ## Status Comments (IMPORTANT)
            Post status updates to the issue using `gh issue comment ${{ needs.find-work.outputs.issue_number }} --body "..."`:
            1. **Before starting**: Post "ü§ñ Starting work on this issue. [View workflow progress](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            2. **After creating PR with auto-merge**: Post "‚úÖ Created PR #<NUMBER>. Auto-merge enabled - will merge when CI passes."

          claude_args: |
            --max-turns 50
            --dangerously-skip-permissions
            --allowedTools "Edit,MultiEdit,Glob,Grep,LS,Read,Write,Bash(git:*),Bash(gh issue:*),Bash(gh pr:*),Bash(gh api:*),Bash(cd backend && uv run:*),Bash(cd frontend && npm:*)"

      - name: Check failure type and handle appropriately
        if: failure()
        id: check-failure
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if this was a max-turns failure (issue too complex)
          # The claude-code-action saves output with "error_max_turns" subtype
          LOG_FILE="${RUNNER_TEMP}/claude-execution-output.json"

          if [ -f "$LOG_FILE" ] && grep -q "error_max_turns" "$LOG_FILE"; then
            echo "max_turns_exceeded=true" >> $GITHUB_OUTPUT
            echo "Detected max-turns failure - will trigger breakdown"
          else
            echo "max_turns_exceeded=false" >> $GITHUB_OUTPUT
            echo "Other failure type - will request human help"
          fi

      - name: Trigger breakdown for complex issues
        if: failure() && steps.check-failure.outputs.max_turns_exceeded == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Remove claude-working label so issue isn't stuck
          gh issue edit ${{ needs.find-work.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --remove-label "claude-working" || true

          # Comment about breakdown
          gh issue comment ${{ needs.find-work.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --body "$(cat <<'EOF'
          ## üîÑ Issue Too Complex - Breaking Down

          This issue exceeded the 50-turn limit, indicating it's too complex for a single automated run.

          **Triggering automatic breakdown** into smaller sub-tasks...

          [View workflow progress](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )"

          # Trigger breakdown workflow
          gh api repos/${{ github.repository }}/dispatches \
            -f event_type=claude-breakdown-needed \
            -f 'client_payload[issue_number]=${{ needs.find-work.outputs.issue_number }}'

      - name: Mark as needing human help for other failures
        if: failure() && steps.check-failure.outputs.max_turns_exceeded != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUM="${{ needs.find-work.outputs.issue_number }}"
          REPO_OWNER="${{ github.repository_owner }}"

          # Remove claude-working, add needs-human-help (prevents re-pickup)
          gh issue edit $ISSUE_NUM \
            --repo ${{ github.repository }} \
            --remove-label "claude-working" \
            --add-label "needs-human-help" || true

          # Unassign claude[bot] and assign to repo owner
          gh api repos/${{ github.repository }}/issues/$ISSUE_NUM/assignees \
            -X DELETE \
            -f 'assignees[]=claude[bot]' || true
          gh issue edit $ISSUE_NUM \
            --repo ${{ github.repository }} \
            --add-assignee "$REPO_OWNER" || true

          # Post comment
          gh issue comment $ISSUE_NUM \
            --repo ${{ github.repository }} \
            --body "$(cat <<'COMMENTEOF'
          ## ‚ùå Claude needs help

          **Status:** Work failed or was blocked

          **Workflow Run:** [View details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          **To retry:** Add your input as a comment, then assign this issue to `claude[bot]`
          COMMENTEOF
          )"

      - name: Mark work complete on success
        # On SUCCESS: remove claude-working, add in-review (prevents re-pickup)
        # The in-review label will be removed when issue closes after deploy
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue edit ${{ needs.find-work.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --remove-label "claude-working" \
            --add-label "in-review" || true

  # Self-chain: trigger another run if there's more work
  # Runs on always() so failures don't stop the queue - other issues still get processed
  # Failed issues get needs-human-help label, successful issues get in-review label
  # Both labels prevent re-pickup in find-work (prevents infinite loops/duplicate PRs)
  continue-work:
    needs: [find-work, work-on-issue]
    if: always() && needs.find-work.outputs.has_more_work == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Trigger next work cycle
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "More issues to process, triggering next work cycle..."
          gh api repos/${{ github.repository }}/dispatches \
            -f event_type=claude-work-continue
