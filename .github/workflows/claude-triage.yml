name: Claude Issue Triage

on:
  issues:
    types: [opened, labeled]

jobs:
  triage:
    # Run when:
    # 1. New issue is opened (GitHub ignores labels= URL param, so we must trigger on opened)
    # 2. P3 label is manually added
    # Skip if issue already has a priority label (P0/P1/P2) to prevent re-triage
    if: >
      (github.event.action == 'opened') ||
      (github.event.action == 'labeled' && github.event.label.name == 'P3')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are triaging a new GitHub issue for the Thinkers Chat project.

            REPOSITORY: ${{ github.repository }}
            ISSUE NUMBER: #${{ github.event.issue.number }}
            TITLE: ${{ github.event.issue.title }}
            BODY: ${{ github.event.issue.body }}
            AUTHOR: ${{ github.event.issue.user.login }}
            CURRENT LABELS: ${{ join(github.event.issue.labels.*.name, ', ') }}

            ## Priority Definitions
            - P0: Blocks most or all functionality (critical bugs, system down)
            - P1: Blocks some functionality OR new feature requests
            - P2: Optimizations, cleanup, refactoring, minor improvements
            - P3: Unprioritized (needs triage) - should be upgraded to P0/P1/P2

            ## Type Definitions
            - bug: Something isn't working correctly
            - enhancement: New feature or improvement request
            - task: General work item, cleanup, or maintenance

            ## Your Task
            1. Read and understand the issue
            2. Determine the appropriate priority (P0, P1, or P2)
            3. Determine the type (bug, enhancement, or task) based on the content
               - Don't assume "Bug:" prefix means it's a bug - read the content!
            4. Check if this might be a duplicate of existing issues
            5. Update the issue with correct labels

            ## Actions to Take
            1. Remove P3 label if present and add the correct priority label (P0, P1, or P2)
            2. Add type label (bug, enhancement, or task) based on the issue content
            3. Add a brief comment explaining your triage decision and priority rationale

            Use these commands:
            - `gh issue edit ${{ github.event.issue.number }} --remove-label "P3" --add-label "P1,bug"` (adjust labels as needed)
            - `gh issue edit ${{ github.event.issue.number }} --add-label "P2,enhancement"` (for new issues without P3)
            - `gh issue comment ${{ github.event.issue.number }} --body "..."`
            - `gh issue list` to check for duplicates

          claude_args: |
            --dangerously-skip-permissions
            --allowedTools "Bash(gh issue:*),Bash(gh search:*)"
