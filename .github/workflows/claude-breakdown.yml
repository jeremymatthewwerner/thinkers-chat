name: Claude Issue Breakdown

# Automatically break down complex issues that exceeded max-turns into smaller sub-tasks

on:
  # Triggered by work workflow when max-turns is hit
  repository_dispatch:
    types: [claude-breakdown-needed]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to break down'
        required: true
        type: number

# Only one breakdown at a time per issue
concurrency:
  group: claude-breakdown-${{ github.event.client_payload.issue_number || github.event.inputs.issue_number }}
  cancel-in-progress: false

jobs:
  breakdown:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Get issue details
        id: issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.client_payload.issue_number }}"
          fi

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          # Get issue details
          ISSUE_DATA=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER)
          ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body')
          ISSUE_LABELS=$(echo "$ISSUE_DATA" | jq -r '[.labels[].name] | join(",")')

          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT

          # Save body to file (may be long)
          echo "$ISSUE_BODY" > /tmp/issue_body.txt

      - name: Check if already a sub-task (prevent recursive breakdown)
        id: check-depth
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_BODY=$(cat /tmp/issue_body.txt)

          # Check if this issue is already a sub-task (has "Parent Issue" or "Part of #")
          if echo "$ISSUE_BODY" | grep -qE "(Parent Issue|Part of #)"; then
            echo "is_subtask=true" >> $GITHUB_OUTPUT
            echo "⚠️ This is already a sub-task - will not break down further"
          else
            echo "is_subtask=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip breakdown for sub-tasks (request human help instead)
        if: steps.check-depth.outputs.is_subtask == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUM="${{ steps.issue.outputs.issue_number }}"
          REPO_OWNER="${{ github.repository_owner }}"

          # Mark as needing human help
          gh issue edit $ISSUE_NUM \
            --repo ${{ github.repository }} \
            --add-label "needs-human-help" \
            --remove-label "claude-working" || true

          # Assign to repo owner
          gh issue edit $ISSUE_NUM \
            --repo ${{ github.repository }} \
            --add-assignee "$REPO_OWNER" || true

          # Comment explaining why
          gh issue comment $ISSUE_NUM \
            --repo ${{ github.repository }} \
            --body "## ⚠️ Cannot Break Down Further

          This issue is already a sub-task and hit the 50-turn limit. Breaking it down further would create too much fragmentation.

          **Human review needed** to either:
          1. Simplify the scope of this sub-task
          2. Manually break it into focused pieces
          3. Provide additional context to help automation succeed

          cc @$REPO_OWNER"

          echo "Skipped breakdown - marked as needs-human-help"
          exit 0

      - name: Mark issue as being broken down
        if: steps.check-depth.outputs.is_subtask != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue edit ${{ steps.issue.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --add-label "breaking-down" \
            --remove-label "needs-human-help" || true

      - name: Break down issue with Claude
        if: steps.check-depth.outputs.is_subtask != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ## Task: Assess and Potentially Break Down Issue

            Issue #${{ steps.issue.outputs.issue_number }} exceeded the 50-turn limit. Before breaking it down, you MUST assess whether breakdown is actually needed.

            ### Original Issue
            **Title:** ${{ steps.issue.outputs.issue_title }}
            **Body:**
            $(cat /tmp/issue_body.txt)

            ## Step 1: ASSESS (Required Before Any Breakdown)

            First, determine WHY the issue hit the turn limit. Check the issue comments for clues:
            ```bash
            gh issue view ${{ steps.issue.outputs.issue_number }} --repo ${{ github.repository }} --comments
            ```

            **Is breakdown actually needed?** Consider:

            1. **Simple task stuck on CI?** (e.g., a string rename hitting linting/test failures)
               → DO NOT break down. Comment that CI needs fixing first and remove `claude-working` label.

            2. **Single logical change across many files?** (e.g., rename across 20 files)
               → DO NOT break down. This is one task, just tedious. Retry with higher turn limit.

            3. **Actually complex with multiple independent deliverables?** (e.g., new feature needing DB + API + UI)
               → YES, break down into independent sub-tasks.

            **If breakdown is NOT needed**, run:
            ```bash
            gh issue comment ${{ steps.issue.outputs.issue_number }} --repo ${{ github.repository }} --body "## Assessment: Breakdown Not Needed

            After analyzing the issue and previous attempts, this does not need to be broken into sub-tasks.

            **Reason:** <explain why - e.g., 'This is a single logical change that hit CI issues'>

            **Recommended action:** <what should be tried instead>

            Removing labels and leaving for next work cycle to retry."

            gh issue edit ${{ steps.issue.outputs.issue_number }} --repo ${{ github.repository }} --remove-label "claude-working,breaking-down"
            ```
            Then STOP - do not create any sub-issues.

            ## Step 2: Break Down (Only If Truly Complex)

            If and ONLY if the issue genuinely needs breakdown:

            1. **Identify natural sub-tasks** - Break it into 3-6 smaller pieces that can each be done in ~20 turns
            2. **Create sub-issues** - Each should be:
               - Self-contained and independently testable
               - Clearly scoped with specific acceptance criteria
               - Ordered by dependency (what needs to be done first)

            ### Creating Sub-Issues

            Use this format for each sub-issue:
            ```bash
            gh issue create \
              --repo ${{ github.repository }} \
              --title "Sub-task: <specific task>" \
              --label "P1,task" \
              --body "## Parent Issue
            Part of #${{ steps.issue.outputs.issue_number }}

            ## Description
            <what needs to be done>

            ## Acceptance Criteria
            - [ ] <criterion 1>
            - [ ] <criterion 2>

            ## Dependencies
            <any sub-tasks that must be done first, or 'None'>"
            ```

            ### After Creating Sub-Issues

            1. Comment on the parent issue listing all created sub-issues:
            ```bash
            gh issue comment ${{ steps.issue.outputs.issue_number }} --body "## Issue Breakdown

            This issue has been broken down into smaller sub-tasks:

            - #<num1> - <title1>
            - #<num2> - <title2>
            ...

            The parent issue will be closed when all sub-tasks are complete."
            ```

            2. Add the 'epic' label to the parent issue and remove priority labels (sub-issues have their own priorities):
            ```bash
            gh issue edit ${{ steps.issue.outputs.issue_number }} --add-label "epic" --remove-label "P0,P1,P2,P3"
            ```

            ### Guidelines
            - Each sub-task should be small enough to complete in one automated run
            - Order sub-tasks by dependency - infrastructure/schema first, then backend, then frontend
            - Keep acceptance criteria specific and testable
            - Don't over-engineer - keep scope minimal

          claude_args: |
            --max-turns 30
            --dangerously-skip-permissions
            --allowedTools "Bash(gh issue:*),Bash(gh search:*)"

      - name: Cleanup labels
        if: always() && steps.check-depth.outputs.is_subtask != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue edit ${{ steps.issue.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --remove-label "breaking-down" || true
